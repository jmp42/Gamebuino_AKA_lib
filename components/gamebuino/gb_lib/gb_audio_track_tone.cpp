/*
This file is part of the Gamebuino-AKA library,
Copyright (c) Gamebuino 2026

This is free software: you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License (LGPL)
as published by the Free Software Foundation, either version 3 of
the License, or (at your option) any later version.

This is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License (LGPL) for more details.

You should have received a copy of the GNU Lesser General Public
License (LGPL) along with the library.
If not, see <http://www.gnu.org/licenses/>.

Authors:
 - Jean-Marie Papillon
*/
#include "gb_audio_track_tone.h"
#include "stdio.h"

    // sin wav table
//static const int16_t i16_sin_tab[256] = { 0, 	804, 	1608, 	2410, 	3212, 	4011, 	4808, 	5602, 	6393, 	7179, 	7962, 	8739, 	9512, 	10278, 	11039, 	11793, 	12539, 	13279, 	14010, 	14732, 	15446, 	16151, 	16846, 	17530, 	18204, 	18868, 	19519, 	20159, 	20787, 	21403, 	22005, 	22594, 	23170, 	23731, 	24279, 	24811, 	25329, 	25832, 	26319, 	26790, 	27245, 	27683, 	28105, 	28510, 	28898, 	29268, 	29621, 	29956, 	30273, 	30571, 	30852, 	31113, 	31356, 	31580, 	31785, 	31971, 	32137, 	32285, 	32412, 	32521, 	32609, 	32678, 	32728, 	32757, 	32767, 	32757, 	32728, 	32678, 	32609, 	32521, 	32412, 	32285, 	32137, 	31971, 	31785, 	31580, 	31356, 	31113, 	30852, 	30571, 	30273, 	29956, 	29621, 	29268, 	28898, 	28510, 	28105, 	27683, 	27245, 	26790, 	26319, 	25832, 	25329, 	24811, 	24279, 	23731, 	23170, 	22594, 	22005, 	21403, 	20787, 	20159, 	19519, 	18868, 	18204, 	17530, 	16846, 	16151, 	15446, 	14732, 	14010, 	13279, 	12539, 	11793, 	11039, 	10278, 	9512, 	8739, 	7962, 	7179, 	6393, 	5602, 	4808, 	4011, 	3212, 	2410, 	1608, 	804, 	0, 	-804, 	-1608, 	-2410, 	-3212, 	-4011, 	-4808, 	-5602, 	-6393, 	-7179, 	-7962, 	-8739, 	-9512, 	-10278, -11039,	-11793,	-12539,	-13279,	-14010,	-14732,	-15446,	-16151,	-16846, 	-17530, 	-18204, 	-18868, 	-19519, 	-20159, 	-20787, 	-21403, 	-22005, 	-22594, 	-23170, 	-23731, 	-24279, 	-24811, 	-25329, 	-25832, 	-26319, 	-26790, 	-27245, 	-27683, 	-28105, 	-28510, 	-28898, 	-29268, 	-29621, 	-29956, 	-30273, 	-30571, 	-30852, 	-31113, 	-31356, 	-31580, 	-31785, 	-31971, 	-32137, 	-32285, 	-32412, 	-32521, 	-32609, 	-32678, 	-32728, 	-32757, 	-32767, 	-32757, 	-32728, 	-32678, 	-32609, 	-32521, 	-32412, 	-32285, 	-32137, 	-31971, 	-31785, 	-31580, 	-31356, 	-31113, 	-30852, 	-30571, 	-30273, 	-29956, 	-29621, 	-29268, 	-28898, 	-28510, 	-28105, 	-27683, 	-27245, 	-26790, 	-26319, 	-25832, 	-25329, 	-24811, 	-24279, 	-23731, 	-23170, 	-22594, 	-22005, 	-21403, 	-20787, 	-20159, 	-19519, 	-18868, 	-18204, 	-17530, 	-16846, 	-16151, 	-15446, 	-14732, 	-14010, 	-13279, 	-12539, 	-11793, 	-11039, 	-10278, 	-9512, 	-8739, 	-7962, 	-7179, 	-6393, 	-5602, 	-4808, 	-4011, 	-3212, 	-2410, 	-1608, 	-1608 };
static const int16_t i16_sin_tab[256]       = { 0,	804,	1608,	2410,	3212,	4011,	4808,	5602,	6393,	7179,	7962,	8739,	9512,	10278,	11039,	11793,	12539,	13279,	14010,	14732,	15446,	16151,	16846,	17530,	18204,	18868,	19519,	20159,	20787,	21403,	22005,	22594,	23170,	23731,	24279,	24811,	25329,	25832,	26319,	26790,	27245,	27683,	28105,	28510,	28898,	29268,	29621,	29956,	30273,	30571,	30852,	31113,	31356,	31580,	31785,	31971,	32137,	32285,	32412,	32521,	32609,	32678,	32728,	32757,	32767,	32757,	32728,	32678,	32609,	32521,	32412,	32285,	32137,	31971,	31785,	31580,	31356,	31113,	30852,	30571,	30273,	29956,	29621,	29268,	28898,	28510,	28105,	27683,	27245,	26790,	26319,	25832,	25329,	24811,	24279,	23731,	23170,	22594,	22005,	21403,	20787,	20159,	19519,	18868,	18204,	17530,	16846,	16151,	15446,	14732,	14010,	13279,	12539,	11793,	11039,	10278,	9512,	8739,	7962,	7179,	6393,	5602,	4808,	4011,	3212,	2410,	1608,	804,	0,	-804,	-1608,	-2410,	-3212,	-4011,	-4808,	-5602,	-6393,	-7179,	-7962,	-8739,	-9512,	-10278,	-11039,	-11793,	-12539,	-13279,	-14010,	-14732,	-15446,	-16151,	-16846,	-17530,	-18204,	-18868,	-19519,	-20159,	-20787,	-21403,	-22005,	-22594,	-23170,	-23731,	-24279,	-24811,	-25329,	-25832,	-26319,	-26790,	-27245,	-27683,	-28105,	-28510,	-28898,	-29268,	-29621,	-29956,	-30273,	-30571,	-30852,	-31113,	-31356,	-31580,	-31785,	-31971,	-32137,	-32285,	-32412,	-32521,	-32609,	-32678,	-32728,	-32757,	-32767,	-32757,	-32728,	-32678,	-32609,	-32521,	-32412,	-32285,	-32137,	-31971,	-31785,	-31580,	-31356,	-31113,	-30852,	-30571,	-30273,	-29956,	-29621,	-29268,	-28898,	-28510,	-28105,	-27683,	-27245,	-26790,	-26319,	-25832,	-25329,	-24811,	-24279,	-23731,	-23170,	-22594,	-22005,	-21403,	-20787,	-20159,	-19519,	-18868,	-18204,	-17530,	-16846,	-16151,	-15446,	-14732,	-14010,	-13279,	-12539,	-11793,	-11039,	-10278,	-9512,	-8739,	-7962,	-7179,	-6393,	-5602,	-4808,	-4011,	-3212,	-2410,	-1608,	-804 };
static const int16_t i16_square_tab[256]    = { 23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173,	-23173 };
static const int16_t i16_triang_tab[256]    = { 0,	512,	1024,	1536,	2048,	2560,	3072,	3584,	4096,	4608,	5120,	5632,	6144,	6656,	7168,	7680,	8192,	8704,	9216,	9728,	10240,	10752,	11264,	11776,	12288,	12800,	13312,	13824,	14336,	14848,	15360,	15872,	16384,	16895,	17407,	17919,	18431,	18943,	19455,	19967,	20479,	20991,	21503,	22015,	22527,	23039,	23551,	24063,	24575,	25087,	25599,	26111,	26623,	27135,	27647,	28159,	28671,	29183,	29695,	30207,	30719,	31231,	31743,	32255,	32767,	32255,	31743,	31231,	30719,	30207,	29695,	29183,	28671,	28159,	27647,	27135,	26623,	26111,	25599,	25087,	24575,	24063,	23551,	23039,	22527,	22015,	21503,	20991,	20479,	19967,	19455,	18943,	18431,	17919,	17407,	16895,	16384,	15872,	15360,	14848,	14336,	13824,	13312,	12800,	12288,	11776,	11264,	10752,	10240,	9728,	9216,	8704,	8192,	7680,	7168,	6656,	6144,	5632,	5120,	4608,	4096,	3584,	3072,	2560,	2048,	1536,	1024,	512,	0,	-512,	-1024,	-1536,	-2048,	-2560,	-3072,	-3584,	-4096,	-4608,	-5120,	-5632,	-6144,	-6656,	-7168,	-7680,	-8192,	-8704,	-9216,	-9728,	-10240,	-10752,	-11264,	-11776,	-12288,	-12800,	-13312,	-13824,	-14336,	-14848,	-15360,	-15872,	-16384,	-16895,	-17407,	-17919,	-18431,	-18943,	-19455,	-19967,	-20479,	-20991,	-21503,	-22015,	-22527,	-23039,	-23551,	-24063,	-24575,	-25087,	-25599,	-26111,	-26623,	-27135,	-27647,	-28159,	-28671,	-29183,	-29695,	-30207,	-30719,	-31231,	-31743,	-32255,	-32767,	-32255,	-31743,	-31231,	-30719,	-30207,	-29695,	-29183,	-28671,	-28159,	-27647,	-27135,	-26623,	-26111,	-25599,	-25087,	-24575,	-24063,	-23551,	-23039,	-22527,	-22015,	-21503,	-20991,	-20479,	-19967,	-19455,	-18943,	-18431,	-17919,	-17407,	-16895,	-16384,	-15872,	-15360,	-14848,	-14336,	-13824,	-13312,	-12800,	-12288,	-11776,	-11264,	-10752,	-10240,	-9728,	-9216,	-8704,	-8192,	-7680,	-7168,	-6656,	-6144,	-5632,	-5120,	-4608,	-4096,	-3584,	-3072,	-2560,	-2048,	-1536,	-1024,	-512 };
static const int16_t i16_noise_tab[256]     = {	-5554,	29798,	-2199,	-4933,	-25478,	14637,	15438,	-9165,	22651,	-8317,	14239,	-31876,	-2554,	-26025,	-26529,	20274,	-22475,	-9183,	13897,	-15975,	-16429,	15490,	21394,	23243,	-5941,	-19470,	14919,	-4855,	18474,	-7117,	31288,	-18661,	-2856,	28899,	-10911,	-31556,	-25227,	2094,	-8599,	-30315,	-3750,	16514,	-2162,	-31456,	19992,	-24361,	-21319,	-26637,	-26587,	-15000,	15930,	5825,	12491,	-5691,	-12872,	-582,	17453,	-31463,	-8042,	-24716,	32703,	-26876,	-7051,	-20350,	13846,	9156,	-16964,	-1250,	-18070,	-17670,	17364,	5227,	-8742,	-5859,	-20003,	-19135,	-8584,	625,	9693,	20031,	24214,	-19745,	31572,	18390,	20429,	23140,	12754,	-28582,	26196,	-15218,	-20761,	19175,	25413,	-8619,	11207,	-27842,	25662,	24636,	-31506,	-3695,	-12650,	10116,	31636,	-12583,	21168,	-11403,	-28952,	10583,	10255,	14238,	9792,	-18477,	16715,	20813,	31592,	-8945,	-13778,	-14609,	-20972,	-22781,	12999,	-23209,	3713,	-29183,	13531,	-15777,	17096,	12385,	13858,	5046,	151,	-27400,	16323,	-25377,	-32246,	137,	6577,	25530,	32176,	-9449,	-17160,	22869,	-26663,	-2887,	-27116,	-23059,	32439,	-32154,	9459,	14824,	784,	-12712,	17860,	20924,	20067,	1618,	-18783,	-23979,	10523,	9095,	30208,	-15822,	8361,	30709,	21925,	-28410,	-30540,	-15481,	-30103,	-24623,	-3879,	-30780,	-7506,	-13557,	-4052,	-26674,	-19208,	-7238,	15531,	-13393,	-11835,	-6452,	15435,	-7042,	-11049,	-23244,	23513,	-20257,	1294,	29598,	32312,	-17965,	12248,	-4866,	-13154,	-30394,	32589,	-2763,	14376,	-27173,	-14471,	-6510,	-17732,	19088,	23786,	29362,	-8286,	-17559,	2348,	16751,	-17825,	7116,	-29528,	11146,	-18904,	-3258,	-13995,	4987,	11365,	25296,	22276,	-23912,	14751,	-29735,	-16130,	24244,	-22912,	-25141,	22138,	11827,	3185,	8164,	-24562,	16538,	-13746,	-6803,	6177,	-18079,	-30652,	-1106,	-16121,	-3089,	28682,	-676,	869,	-10220,	-30086,	-30783,	14698,	-15064,	-5946,	-19491,	-10458,	14779,	28058,	-21136 };
static const int16_t* i16_effect_tab[4]     = { i16_sin_tab, i16_square_tab, i16_triang_tab, i16_noise_tab };

        //! start playing sound for duration and frequency
void gb_audio_track_tone::play_tone( float f32_frequency, float f32_volume, uint16_t u16_duration_ms, tone_type type )
{
        // play continuous tone
    play_tone( f32_frequency, f32_frequency, f32_volume, f32_volume, u16_duration_ms, type );
}

    //! start playing sound for duration(ms) and frequency(Hz) with effect on freq and volume. Note : volume range 0.0 to 1.0
void gb_audio_track_tone::play_tone( float f32_start_frequency, float f32_end_frequency, float f32_start_volume,  float f32_end_volume, uint16_t u16_duration_ms, tone_type fx_type )
{
    if ( is_playing() ) {
        stop_playing(); // allow to break song, and start new
    }
        
        // convert 1 sinus period for 256 samples to user freq
	u32_sin_inc_start = (uint32_t)(65536.0f*f32_start_frequency*256.0f/GB_AUDIO_SAMPLE_RATE);
	u32_sin_inc_end = (uint32_t)(65536.0f*f32_end_frequency*256.0f/GB_AUDIO_SAMPLE_RATE);
    i32_volume_start = BOUND(f32_start_volume, 0.0, 1.0)*65535;
    i32_volume_end = BOUND(f32_end_volume, 0.0, 1.0)*65535;
    _fx_type = fx_type;

    if ( !u32_sin_sample_total )
        i32_cb_loop_count = 0;
        // convert duration ms to sample count
    u32_sin_sample_total = (uint32_t)(u16_duration_ms) * GB_AUDIO_SAMPLE_RATE / 1000;
    u32_sin_sample_index = 0; // playback from begin
}

            // return playing state
bool gb_audio_track_tone::is_playing()
{
    return u32_sin_sample_total?true:false;
}


        // stop sound
void gb_audio_track_tone::stop_playing()
{
    u32_sin_sample_total = 0;
    u32_sin_read_index = 0;
}


        //! buffer fill callback 
int gb_audio_track_tone::play_callback( int16_t* pi16_buffer, uint16_t u16_sample_count )
{
    if ( u32_sin_sample_total )
    {
        uint32_t u32_sin_inc = u32_sin_inc_start + (u32_sin_inc_end - u32_sin_inc_start)*u32_sin_sample_index/u32_sin_sample_total;
        int32_t i32_volume = i32_volume_start + (i32_volume_end - i32_volume_start)*(int64_t)u32_sin_sample_index/(int64_t)u32_sin_sample_total;
//        printf("vol %ld %ld/%ld\n", i32_volume, u32_sin_sample_index, u32_sin_sample_total);
            // fill caller buffer with sine
        const int16_t* i16_effect = i16_effect_tab[_fx_type&3];
        for ( int i = 0 ; i < u16_sample_count ; i++ )
            pi16_buffer[i] = i16_effect[((u32_sin_read_index+=u32_sin_inc)/65536)&0xFF]*i32_volume/65536;

            // start playing : apply fade in to buffer ( progressive volume up )
        if ( i32_cb_loop_count == 0 )
            fade_in_buffer(pi16_buffer);

            // count remaining of sample to generate
        u32_sin_sample_index += u16_sample_count;
        if ( u32_sin_sample_index >  u32_sin_sample_total ) // end of generation
        {
                // end of playing : apply fade out to buffer ( progressive volume down )
            stop_playing();
            fade_out_buffer(pi16_buffer);
        }
        i32_cb_loop_count++;
        return 0; // success
    }
    return -1; // not playing
}

